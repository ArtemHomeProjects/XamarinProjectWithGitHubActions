  on:
    push:
      branches:
        - main
      tags:
        - RC.*

  # This workflow_dispatch allows
  # you to trigger the workflow manually.  
    workflow_dispatch:

  jobs:
    build:
      runs-on: macos-latest

      steps:
        - name: Checkout
          uses: actions/checkout@v2

        - name: Setup iOS Certificates
          uses: apple-actions/import-codesign-certs@v1
          with:
            p12-file-base64: ${{ secrets.CERTIFICATES_P12 }}
            p12-password: ${{ secrets.CERTIFICATES_P12_PASSWORD }}
            keychain: github-actions-xamarin
            keychain-password: ''

        - name: Setup iOS Provisioning Profiles
          uses: apple-actions/download-provisioning-profiles@v1
          with:
            bundle-id: 'com.mymedsandme.*'
            issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
            api-key-id: ${{ secrets.APPSTORE_KEY_ID }}
            api-private-key: ${{ secrets.APPSTORE_PRIVATE_KEY }}

        - name: Setup Android signing
          run: (echo ${{ secrets.KEYSTORE }} | base64 - decode) > ./TestGithubActions.Droid/keystore.jks

#        - name: Update iOS version Info.plist
#          uses: damienaicheh/update-ios-version-info-plist-action@v1.0.0
#          with:
#            info-plist-path: "./TestGithubActions.iOS/Info.plist"
#            bundle-short-version-string: ${{ secrets.APP_VERSION }}
#            bundle-version: ${{ github.run_number }}"
#            print-file: true

        - name: Update iOS version Info.plist
          run: |
              for f in */Info.plist
              do
                /usr/libexec/PlistBuddy $f -c "Set :CFBundleVersion $GITHUB_RUN_NUMBER"
              done
              sed -i '' -e 's/\(\([0-9]\{1,\}\.\)\{1,\}\)\([0-9]\)/\1'"$GITHUB_RUN_NUMBER"'/g' */Properties/AssemblyInfo.cs

        - name: Set Android version
          uses: damienaicheh/update-android-version-manifest-action@v1.0.0
          with:
            android-manifest-path: ./TestGithubActions.Droid/Properties/AndroidManifest.xml
            version-name: ${{ secrets.APP_VERSION }}
            version-code: ${{ github.run_number }}

        - name: Restore NuGet packages
          run: nuget restore

        - name: Build iOS
          run: MSBuild
            /t:Build
            /p:Configuration=Release
            /p:Platform=iPhone
            /p:BuildIpa=true
            ./TestGithubActions.iOS/TestGithubActions.iOS.csproj

        - name: 'Upload app to TestFlight'
          uses: apple-actions/upload-testflight-build@v1
          with:
            app-path: './TestGithubActions.iOS/bin/iPhone/Release/TestGithubActions.iOS.ipa'
            issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
            api-key-id: ${{ secrets.APPSTORE_KEY_ID }}
            api-private-key: ${{ secrets.APPSTORE_PRIVATE_KEY }}

#        - name: Build Android
#          run: MSBuild
#            /t:SignAndroidPackage
#            /p:Configuration=Release
#            /p:AndroidPackageFormat=apk
#            /p:AndroidKeyStore=true
#            /p:AndroidSigningKeyAlias=${{ secrets.KEYSTORE_ALIAS }}
#            /p:AndroidSigningKeyPass=${{ secrets.KEYSTORE_PASSWORD }}
#            /p:AndroidSigningKeyStore=keystore.jks
#            /p:AndroidSigningStorePass=${{ secrets.KEYSTORE_PASSWORD }}
#            ./TestGithubActions.Droid/TestGithubActions.Droid.csproj