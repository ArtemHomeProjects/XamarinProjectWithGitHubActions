  on:
    push:
      branches:
        - main
      tags:
        - RC.*

  # This workflow_dispatch allows
  # you to trigger the workflow manually.  
    workflow_dispatch:
      inputs:
        buildConfiguration:
          type: choice
          description: Choose a holder
          options:
            - Debug
            - Release
            - AAPharmaDEV
            - AAPharmaProd
            - AAPharmaDEMO
            - AAPharmaVAL
            - GSIRProd
            - GSIRDev
            - GSIRVal
            - AAPharmaDev
            - MMMPharmaVal
            - MMMPharmaProd
            - MMMPharmaDev
            - MMMPharmaDemo
            - AAPharmaDemo
            - IndiviorDev
            - IndiviorVal
            - ReportumDev
            - ReportumProd
            - ReportumVal
            - BayerDev
            - BayerProd
            - BayerVal
          required: true

  jobs:
      build:
        name: Setup Xamarin and Mono versions
        runs-on: macos-latest
        steps:
          - name: setup-xamarin
            uses: maxim-lobanov/setup-xamarin@v1
            with:
              mono-version: '6.6' # specify version in '<major>.<minor>' format
              xamarin-ios-version: latest # specify version in '<major>' format
              xamarin-mac-version: latest # specify 'latest' keyword to pick up the latest available version
              xamarin-android-version: '10.1.3.7' # specify full version; it is not recomended option because your pipeline can be broken suddenly in future
              xcode-version: latest # set the latest available Xcode 11

      steps:
        - name: Checkout
          uses: actions/checkout@v2

        - name: Setup iOS Certificates
          uses: apple-actions/import-codesign-certs@v1
          with:
            p12-file-base64: ${{ secrets.CERTIFICATES_P12 }}
            p12-password: ${{ secrets.CERTIFICATES_P12_PASSWORD }}
            keychain: github-actions-xamarin
            keychain-password: ''

        - name: Setup iOS Provisioning Profiles
          uses: apple-actions/download-provisioning-profiles@v1
          with:
            bundle-id: 'com.mymedsandme.*'
            issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
            api-key-id: ${{ secrets.APPSTORE_KEY_ID }}
            api-private-key: ${{ secrets.APPSTORE_PRIVATE_KEY }}

#        - name: Setup Android signing
#          run: (echo ${{ secrets.KEYSTORE }} | base64 - decode) > ./TestGithubActions.Droid/keystore.jks

#        - name: Update iOS version Info.plist
#          uses: damienaicheh/update-ios-version-info-plist-action@v1.0.0
#          with:
#            info-plist-path: "./TestGithubActions.iOS/Info.plist"
#            bundle-short-version-string: ${{ secrets.APP_VERSION }}
#            bundle-version: ${{ github.run_number }}"
#            print-file: true

        - name: Update iOS version Info.plist
          run: |
              for f in */Info.plist
              do
                /usr/libexec/PlistBuddy $f -c "Set :CFBundleVersion $GITHUB_RUN_NUMBER"
              done
              sed -i '' -e 's/\(\([0-9]\{1,\}\.\)\{1,\}\)\([0-9]\)/\1'"$GITHUB_RUN_NUMBER"'/g' */Properties/AssemblyInfo.cs

#        - name: Set Android version
#          uses: damienaicheh/update-android-version-manifest-action@v1.0.0
#          with:
#            android-manifest-path: ./TestGithubActions.Droid/Properties/AndroidManifest.xml
#            version-name: ${{ secrets.APP_VERSION }}
#            version-code: ${{ github.run_number }}

        - name: Restore NuGet packages
          run: nuget restore

        - name: Build iOS
          run: MSBuild
            /t:Build
            /p:Configuration=${{ github.event.inputs.buildConfiguration }}
            /p:Platform=iPhone
            /p:BuildIpa=true
            ./TestGithubActions.iOS/TestGithubActions.iOS.csproj

        - name: 'Upload app to TestFlight'
          uses: apple-actions/upload-testflight-build@v1
          with:
            app-path: './TestGithubActions.iOS/bin/iPhone/${{ github.event.inputs.buildConfiguration }}/TestGithubActions.iOS.ipa'
            issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
            api-key-id: ${{ secrets.APPSTORE_KEY_ID }}
            api-private-key: ${{ secrets.APPSTORE_PRIVATE_KEY }}

#        - name: Build Android
#          run: MSBuild
#            /t:SignAndroidPackage
#            /p:Configuration=Release
#            /p:AndroidPackageFormat=apk
#            /p:AndroidKeyStore=true
#            /p:AndroidSigningKeyAlias=${{ secrets.KEYSTORE_ALIAS }}
#            /p:AndroidSigningKeyPass=${{ secrets.KEYSTORE_PASSWORD }}
#            /p:AndroidSigningKeyStore=keystore.jks
#            /p:AndroidSigningStorePass=${{ secrets.KEYSTORE_PASSWORD }}
#            ./TestGithubActions.Droid/TestGithubActions.Droid.csproj